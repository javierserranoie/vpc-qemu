#cloud-config
hostname: node-1
locale: en_US.UTF-8
keyboard:
  layout: es
ssh_pwauth: true
users:
  - name: debian
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: "$6$O5cWGwE/ujy963Cw$yPzx8W0GvzmeG5.ZKQ3d1SPG0g3P7E8iP.1BX4XgSkH/b4bNpHw1ksnrzKQ9e7W3DkPqiSWqogX47CQjYrHp30"
    groups: [adm, audio, cdrom, dialout, dip, floppy, lxd, netdev, plugdev, sudo, video]
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBx9tOXmE7sQzeom2e4MH+k6g7VbARz9GXqGmaeJfmZ/ javiserranoie@gmail.com

packages:
  - kbd
  - console-setup
  - keyboard-configuration
  - fish
  - htop
  - btop
  - nftables
  - neovim

runcmd:
  - echo "debian:debian" | chpasswd
  - locale-gen en_US.UTF-8
  - update-locale LANG=en_US.UTF-8
  - DEBIAN_FRONTEND=noninteractive apt-get update
  - DEBIAN_FRONTEND=noninteractive apt-get install -y kbd console-setup keyboard-configuration fish htop btop nftables neovim
  - echo "keyboard-configuration keyboard-configuration/layoutcode string es" | debconf-set-selections
  - echo "keyboard-configuration keyboard-configuration/variantcode string " | debconf-set-selections
  - echo "keyboard-configuration keyboard-configuration/modelcode string pc105" | debconf-set-selections
  - DEBIAN_FRONTEND=noninteractive dpkg-reconfigure -f noninteractive keyboard-configuration
  - sed -i 's/XKBLAYOUT=.*/XKBLAYOUT="es"/' /etc/default/keyboard || echo 'XKBLAYOUT="es"' >> /etc/default/keyboard
  - sed -i 's/XKBVARIANT=.*/XKBVARIANT=""/' /etc/default/keyboard || echo 'XKBVARIANT=""' >> /etc/default/keyboard
  - sed -i 's/XKBMODEL=.*/XKBMODEL="pc105"/' /etc/default/keyboard || echo 'XKBMODEL="pc105"' >> /etc/default/keyboard
  - setupcon -k
  - systemctl enable ssh
  - systemctl start ssh
  - systemctl enable sshd
  - systemctl start sshd
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - systemctl restart ssh || systemctl restart sshd || true